<% content_for :breadcrumbs do %>
  <%= render 'shared/breadcrumbs', breadcrumbs: [
    { label: t('teams.label'), url: main_app.teams_path },
    { label: @team.name, url: main_app.team_path(@team) },
    { label: t('training_certificates.label_plural') }
  ] %>
<% end %>

<div class="container mx-auto my-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-800"><%= t('training_certificates.label_plural') %></h1>
    
    <% if can?(:create, TrainingCertificate) && @training_program %>
      <%= link_to t('training_certificates.buttons.new'), 
                  new_team_training_program_training_certificate_path(@team, @training_program),
                  class: "btn btn-primary" %>
    <% end %>
  </div>
  
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200">
      <%= form_with url: request.path, method: :get, class: "flex flex-wrap gap-4" do |form| %>
        <div class="form-group">
          <%= form.label :status, t('training_certificates.filters.status'), class: "form-label" %>
          <%= form.select :status, 
                         options_for_select([
                           [t('training_certificates.status.all'), ''],
                           [t('training_certificates.status.active'), 'active'],
                           [t('training_certificates.status.expired'), 'expired']
                         ], params[:status]),
                         {}, 
                         class: "form-select" %>
        </div>
        
        <% if @training_program.nil? %>
          <div class="form-group">
            <%= form.label :program_id, t('training_certificates.filters.program'), class: "form-label" %>
            <%= form.collection_select :program_id, 
                                      @team.training_programs.published,
                                      :id, 
                                      :name,
                                      { include_blank: t('training_certificates.filters.all_programs') },
                                      class: "form-select" %>
          </div>
        <% end %>
        
        <div class="form-group flex items-end">
          <%= form.submit t('global.buttons.filter'), class: "btn btn-secondary" %>
        </div>
      <% end %>
    </div>
    
    <% if @training_certificates.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.certificate_number') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.program') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.user') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.issued_at') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.expires_at') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.status') %>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('training_certificates.fields.pdf_status') %>
              </th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= t('global.buttons.actions') %>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @training_certificates.each do |certificate| %>
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= certificate.certificate_number %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= certificate.training_program.name %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= "#{certificate.membership.user_first_name} #{certificate.membership.user_last_name}" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= l(certificate.issued_at, format: :short) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <% if certificate.expires_at %>
                    <%= l(certificate.expires_at, format: :short) %>
                  <% else %>
                    <%= t('training_certificates.no_expiration') %>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% if certificate.revoked? %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                      <%= t('training_certificates.status.revoked') %>
                    </span>
                  <% elsif certificate.expired? %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                      <%= t('training_certificates.status.expired') %>
                    </span>
                  <% else %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                      <%= t('training_certificates.status.active') %>
                    </span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% case certificate.pdf_status %>
                  <% when 'processing' %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                      <%= t('training_certificates.pdf_status.processing') %>
                    </span>
                  <% when 'completed' %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                      <%= t('training_certificates.pdf_status.completed') %>
                    </span>
                  <% when 'failed' %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                      <%= t('training_certificates.pdf_status.failed') %>
                    </span>
                  <% else %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                      <%= t('training_certificates.pdf_status.pending') %>
                    </span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <%= link_to t('global.buttons.view'), 
                              training_certificate_path(certificate),
                              class: "text-indigo-600 hover:text-indigo-900" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div class="p-4 border-t border-gray-200">
        <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
      </div>
    <% else %>
      <div class="p-8 text-center text-gray-500">
        <%= t('training_certificates.no_certificates') %>
      </div>
    <% end %>
  </div>
</div>